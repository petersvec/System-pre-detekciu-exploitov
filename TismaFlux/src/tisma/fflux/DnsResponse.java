/*
        |ID (2B)|Flags (2B)|Counts (8B)|query_name|0x00|type (2B)|class (2B)|

query_name - napr. www.google.sk => 0x03www0x06google0x02sk

(12B) |0x03www0x06google0x02sk|0x00|_       _|_        _| 
(12B) |query_name             |0x00|type (2B)|class (2B)|

PREFIX = 12B

 */
package tisma.fflux;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.Date;
import org.jnetpcap.packet.PcapPacket;
import helpers.TParser;

/**
 *
 * @author Lukas Lences
 */
class Response {

    String name;
    String cname;
    byte[] type;
    byte[] clas;
    byte[] ttl;
    byte[] dataLength;
    byte[] address;
    long framenumber;
    Date timestamp;

}

public class DnsResponse extends DnsPacket {

    int firtsByteResponse;
    ArrayList<Response> responses;

    DnsResponse(PcapPacket packet) {
        super(packet);
        //generate query subsection
        byte[] payload = this.udp.getPayload();
        this.QNAME = new ArrayList<>();
        this.responses = new ArrayList<>();
        this.QNAME.add(TParser.domainNameReader(payload, PREFIX));
        this.QTYPE = TParser.parseFrom2BytesToInt(Arrays.copyOfRange(payload, PREFIX + this.QNAME.get(0).length() + 1, PREFIX + this.QNAME.get(0).length() + 3));
        this.QCLASS = TParser.parseFrom2BytesToInt(Arrays.copyOfRange(payload, PREFIX + this.QNAME.get(0).length() + 3, PREFIX + this.QNAME.get(0).length() + 5));
        
        if (this.FLAGS.Rcode == 3) {
          //  System.err.printf("#%d DNS REPLY ERROR: No such domain. \tid: %s \tTO IP: %s \tname: %s \ttype: %d \tclass: %d%n ",
           //         packet.getFrameNumber(), FormatUtils.asString(this.ID),
           //         FormatUtils.ip(dIP), this.QNAME.get(0),
           //         this.QTYPE, this.QCLASS);
           Response t = new Response();
           t.framenumber = packet.getFrameNumber();
           t.name = this.QNAME.get(0);
           t.timestamp = new Date(packet.getCaptureHeader().timestampInMillis());
           this.responses.add(t);    
           
        } else if (this.FLAGS.Rcode == 0) {
            // System.out.printf("#%d DNS REPLY \tid: %s \tsrc: %s \tname: %s \ttype: %d \tclass: %d%n ",
            //        packet.getFrameNumber(), FormatUtils.asString(this.ID),
            //        FormatUtils.ip(sIP), this.QNAME.get(0),
            //        this.QTYPE, this.QCLASS);

            //response, zacina na indexe firstByteResponse
            this.firtsByteResponse = PREFIX + this.QNAME.get(0).length() + 5;

            //kolko odpovedi
            int index = this.firtsByteResponse;

            for (int i = 0; i < this.ANCOUNT; i++) {
                Response t = new Response();
                t.framenumber = packet.getFrameNumber();
                t.timestamp = new Date(packet.getCaptureHeader().timestampInMillis());

                //ak je prvy bit 1, ide o ukazovatel... toto bude pravdepodobne vzdy do zaznamu query
                if ((payload[index] & (byte) 0x80) == (byte) 0x80) {
                    byte[] tmp = Arrays.copyOfRange(payload, index, index + 2);
                    tmp[0] = (byte) (tmp[0] & (byte) 0x3F); //nulovat prve bity
                    //int offset = TParser.parseFrom2BytesToInt(tmp);                
                    int offset = Byte.toUnsignedInt(tmp[1]);
                    t.name = TParser.domainNameReader(payload, offset); //nazov
                    t.type = Arrays.copyOfRange(payload, index + 2, index + 4);
                    t.clas = Arrays.copyOfRange(payload, index + 4, index + 6);
                    t.ttl = Arrays.copyOfRange(payload, index + 6, index + 10);
                    t.dataLength = Arrays.copyOfRange(payload, index + 10, index + 12);
                    if (t.type[1] == (byte) 0x01) {
                        //A zaznam
                        t.address = Arrays.copyOfRange(payload, index + 12, index + 16);
                        //    System.out.printf("Name: %s \thas IP: %s%n", t.name, FormatUtils.ip(t.address));
                    }
                    if (t.type[1] == (byte) 0x05) {
                        //CNAME                  90                        
                        t.cname = TParser.domainNameReader(payload, index + 12);

                        //   System.out.printf("Name %s \tis CNAME:%s%n", t.name, t.cname);
                    }

                    //musim posunut index
                    index += 2; //name, v tejto vetve ifu je to vzdy 2, lebo odkaz C00C
                    index += 2 + 2 + 4; //type + clas + ttl;
                    index += 2; //datalength
                    index += TParser.parseFrom2BytesToInt(t.dataLength); //dlzka cname alebo ip adries
                    this.responses.add(t);

                } else {
                    //ak to na zaciatku nebol odkaz                
                }
            }

        }
    }
}
